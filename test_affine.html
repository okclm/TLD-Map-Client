<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Affine Test - TLD Map</title>
</head>
<body>
    <h1>Affine Position Calculator Test</h1>
    <p>Usage: Append ?scene=RuralRegion&x=423.47&y=1458.18 to the URL</p>

    <script>
        // Helper: Get URL query parameter
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Get parameters from URL (with defaults/fallbacks)
        const scene = getQueryParam('scene')?.trim() || null;
        const gameX = parseFloat(getQueryParam('x')?.trim() || '0');
        const gameZ = parseFloat(getQueryParam('z')?.trim() || '0'); // Use 'z' for consistency with game coords

        console.log(`Scene: ${scene}`);
        console.log(`Game X: ${gameX}, Game Z: ${gameZ}`);

        if (!scene) {
            document.body.innerHTML += '<p style="color:red;">Error: Missing ?scene= parameter</p>';
            throw new Error("Missing scene parameter");
        }

        const affineUrl = `https://raw.githubusercontent.com/okclm/TLD-Map-Client/master/affine/${scene}_affine.json`;
        console.log("Fetching affine from:", affineUrl);

        fetch(affineUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Loaded affine data for:", data.region);

                const m = data.affineMatrix;
                if (!m) {
                    throw new Error("No affineMatrix found in data");
                }

                // Compute position (gameX, gameZ → pxX, pxY)
                const pxX = m.A * gameX + m.B * gameZ + m.Tx;
                const pxY = m.C * gameX + m.D * gameZ + m.Ty;

                console.log("Computed position:", pxX.toFixed(2), pxY.toFixed(2));

                // Optional: Display on page
                document.body.innerHTML += `
                        <p><strong>Region:</strong> ${data.region}</p>
                        <p><strong>Game Position:</strong> x=${gameX}, z=${gameZ}</p>
                        <p><strong>Map Position (px):</strong> ${pxX.toFixed(2)}, ${pxY.toFixed(2)}</p>
                    `;
            })
            .catch(error => {
                console.error("Error loading or computing affine:", error);
                document.body.innerHTML += `<p style="color:red;">Error: ${error.message}</p>`;
            });
    </script>
</body>
</html>