<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Affine Test - TLD Map</title>
</head>
<body>
    <h1>Affine Position Calculator Test</h1>
    <p>Usage: Append ?scene=RuralRegion&x=172.53&z=2500.19 to the URL</p>

    <pre>
        This should use the affine for RuralRegion to compute the map position for the given game coordinates.
        Expected output:
        Region: RuralRegion

        Game Position: x=172.53, z=2500.19

        Map Position (px,py): 3978.20863, 119.23147  (Or something close)

        Based on the following POI data:
            {
                "scene": "RuralRegion",
                "x": 172.53,
                "y": 270.15,
                "z": 2500.19,
                "svgX": 3978.20863,
                "svgY": 119.23147,
                "label": "Exit to Timberwolf Mountain"
            }

        And the affine matrix:
            {
              "region": "RuralRegion",
              "affineMatrix": {
                "A": 0.00142720071414083,
                "B": 1.4950626097669975,
                "Tx": -317.8680095759911,
                "C": 1.5038837170024517,
                "D": -0.0034022158191049073,
                "Ty": -635.6807481191483
              },
              "generatedAt": "2026-01-07T15:50:42.5107240Z",
              "calibPointCount": 31,
              "layerOffsetX": 547.95203,
              "layerOffsetY": 495.03543
            }
    </pre>

    <script>
        // Helper: Get URL query parameter
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Get parameters from URL (with defaults/fallbacks)
        const scene = getQueryParam('scene')?.trim() || null;
        const gameX = parseFloat(getQueryParam('x')?.trim() || '0');
        const gameZ = parseFloat(getQueryParam('z')?.trim() || '0'); // Use 'z' for consistency with game coords

        console.log(`Scene: ${scene}`);
        console.log(`Game X: ${gameX}, Game Z: ${gameZ}`);

        if (!scene) {
            document.body.innerHTML += '<p style="color:red;">Error: Missing ?scene= parameter</p>';
            throw new Error("Missing scene parameter");
        }

        const affineUrl = `https://raw.githubusercontent.com/okclm/TLD-Map-Client/master/affine/${scene}_affine.json`;
        console.log("Fetching affine from:", affineUrl);

        fetch(affineUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Loaded affine data for:", data.region);

                const m = data.affineMatrix;
                if (!m) {
                    throw new Error("No affineMatrix found in data");
                }

                // Compute position (gameX, gameZ → pxX, pxY)
                const pxX = m.A * gameX + m.B * gameZ + m.Tx;
                const pxY = m.C * gameX + m.D * gameZ + m.Ty;

                console.log("Computed position:", pxX.toFixed(2), pxY.toFixed(2));

                // Optional: Display on page
                document.body.innerHTML += `
                        <p><strong>data.region:</strong> ${data.region}</p>
                        <p>strong>Affine Data Loaded Successfully</strong></p>
                        <p><strong>m.A, m.B, m.Tx:</strong> ${m.A}, ${m.B}, ${m.Tx}</p>
                        <p><strong>m.C, m.D, m.Ty:</strong> ${m.C}, ${m.D}, ${m.Ty}</p>
                        <p><strong>scene, gameX, gameZ:</strong> ${scene}, ${gameX}, z=${gameZ}</p>
                        <p><strong>Map Position (px,py):</strong> ${pxX.toFixed(2)}, ${pxY.toFixed(2)}</p>
                                            `;

            })
            .catch(error => {
                console.error("Error loading or computing affine:", error);
                document.body.innerHTML += `<p style="color:red;">Error: ${error.message}</p>`;
            });
    </script>
</body>
</html>