<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Affine Test - TLD Map</title>
</head>
<body>
    <h1>Affine Position Calculator Test</h1>
    <p>Usage: Append ?scene=RuralRegion&x=172.53&z=2500.19 to the URL</p>

    <p id="result">Waiting for data...</p>

    <script>
        // Helper: Get URL query parameter
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Get parameters from URL (with defaults/fallbacks)
        const scene = getQueryParam('scene')?.trim() || null;
        const gameX = parseFloat(getQueryParam('x')?.trim() || '0');
        const gameZ = parseFloat(getQueryParam('z')?.trim() || '0'); // Use 'z' for gameZ

        if (!scene) {
            document.getElementById('result').innerHTML =
                '<p style="color:red;">Error: Missing ?scene= parameter</p>';
            throw new Error("Missing scene parameter");
        }

        const affineUrl = `https://raw.githubusercontent.com/okclm/TLD-Map-Client/master/affine/${scene}_affine.json`;
        console.log("Fetching affine from:", affineUrl);

        fetch(affineUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Loaded affine data for:", data.region);

                const m = data.affineMatrix;
                if (!m) {
                    throw new Error("No affineMatrix found in data");
                }

                // Compute position (gameX, gameZ → pxX, pxY)
                //const pxX = m.A * gameX + m.B * gameZ + m.Tx;
                //const pxY = m.C * gameX + m.D * gameZ + m.Ty;

                // In your test_affine.html or map.html
                const pxX = m.A * gameX + m.B * gameZ + m.Tx + data.layerOffsetX;
                const pxY = m.C * gameX + m.D * gameZ + m.Ty + data.layerOffsetY;

                console.log("Computed position:", pxX.toFixed(2), pxY.toFixed(2));

                // Display on page
                document.getElementById('result').innerHTML = `
                        <p><strong>Affine Data Loaded Successfully</strong></p>
                        <p><strong>Region:</strong> ${data.region}</p>
                        <p><strong>Generated At:</strong> ${data.generatedAt}</p>
                        <p><strong>Calibration Points:</strong> ${data.calibPointCount}</p>
                        <p><strong>LayerOffsetX:</strong> ${data.LayerOffsetX}</p>
                        <p><strong>LayerOffsetY:</strong> ${data.LayerOffsetY}</p>
                        <p><strong>Requested Game Position:</strong> Scene=${scene}, x=${gameX}, z=${gameZ}</p>
                        <p><strong>Calculated Map Position (px):</strong> ${pxX.toFixed(2)}, ${pxY.toFixed(2)}</p>
                        <p><strong>Expected (from POI JSON):</strong> 412.57425, 338.77673</p>
                    `;
            })
            .catch(error => {
                console.error("Error:", error);
                document.getElementById('result').innerHTML =
                    `<p style="color:red;">Error: ${error.message}</p>`;
            });
    </script>
</body>
</html>