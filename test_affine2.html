<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Affine Calibration Test - TLD Map</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        h1 {
            color: #333;
        }

        #affine-summary {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            max-width: 600px;
        }

            #affine-summary h3 {
                margin-top: 0;
                color: #2c3e50;
            }

            #affine-summary ul {
                list-style: none;
                padding-left: 0;
            }

            #affine-summary li {
                margin: 6px 0;
            }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .green {
            background-color: #d4edda;
        }

        .yellow {
            background-color: #fff3cd;
        }

        .red {
            background-color: #f8d7da;
        }

        #loading {
            font-style: italic;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>Affine Calibration Test for POI Positions - Version 0.0.2</h1>
    <p>Usage: Append ?scene=RuralRegion&difficulty=hard to the URL</p>
    <p id="loading">Loading affine and POI data...</p>

    <div id="affine-summary" style="display:none;">
        <h3>Affine Data Summary</h3>
        <ul id="affine-list"></ul>
    </div>

    <table id="poi-table">
        <thead>
            <tr>
                <th>Scene</th>
                <th>X</th>
                <th>Y</th>
                <th>Z</th>
                <th>Label</th>
                <th>Recorded svgX</th>
                <th>Recorded svgY</th>
                <th>Calculated svgX</th>
                <th>Calculated svgY</th>
                <th>Delta X</th>
                <th>Delta Y</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        // Helper: Get URL query parameter
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Get parameters from URL (with defaults)
        const scene = getQueryParam('scene')?.trim() || null;
        const difficulty = getQueryParam('difficulty')?.trim().toLowerCase() || 'hard';

        if (!scene) {
            document.getElementById('loading').innerHTML = '<p style="color:red;">Error: Missing ?scene= parameter</p>';
            throw new Error("Missing scene parameter");
        }

        const affineUrl = `https://raw.githubusercontent.com/okclm/TLD-Map-Client/master/affine/${scene}_affine.json`;
        const poiUrl = `https://raw.githubusercontent.com/okclm/TLD-Map-Client/master/pois/${scene}.json`;

        document.getElementById('loading').innerHTML = `Loading affine and POI data for ${scene} (${difficulty})...`;

        async function loadData() {
            try {
                const [affineResponse, poiResponse] = await Promise.all([
                    fetch(affineUrl),
                    fetch(poiUrl)
                ]);

                if (!affineResponse.ok || !poiResponse.ok) {
                    throw new Error(`Failed to load data (affine: ${affineResponse.status}, poi: ${poiResponse.status})`);
                }

                const affine = await affineResponse.json();
                const pois = await poiResponse.json();

                document.getElementById('loading').style.display = 'none';

                // Display affine summary
                const summaryDiv = document.getElementById('affine-summary');
                summaryDiv.style.display = 'block';

                const list = document.getElementById('affine-list');
                list.innerHTML = `
                        <li><strong>Region:</strong> ${affine.region}</li>
                        <li><strong>Calibration Points:</strong> ${affine.calibPointCount}</li>
                        <li><strong>Generated At:</strong> ${affine.generatedAt}</li>
                        <li><strong>Layer Offset X:</strong> ${affine.layerOffsetX?.toFixed(2) || 'N/A'}</li>
                        <li><strong>Layer Offset Y:</strong> ${affine.layerOffsetY?.toFixed(2) || 'N/A'}</li>
                    `;

                // Add affine matrix coefficients
                const m = affine.affineMatrix;
                if (m) {
                    list.innerHTML += `
                            <li><strong>A:</strong> ${m.A.toFixed(8)}</li>
                            <li><strong>B:</strong> ${m.B.toFixed(8)}</li>
                            <li><strong>Tx:</strong> ${m.Tx.toFixed(8)}</li>
                            <li><strong>C:</strong> ${m.C.toFixed(8)}</li>
                            <li><strong>D:</strong> ${m.D.toFixed(8)}</li>
                            <li><strong>Ty:</strong> ${m.Ty.toFixed(8)}</li>
                        `;
                }

                // Build POI table
                const tableBody = document.getElementById('poi-table').getElementsByTagName('tbody')[0];

                pois.forEach(poi => {
                    const calcSvgX = m.A * poi.x + m.B * poi.z + m.Tx;
                    const calcSvgY = m.C * poi.x + m.D * poi.z + m.Ty;

                    const deltaX = Math.abs(calcSvgX - poi.svgX);
                    const deltaY = Math.abs(calcSvgY - poi.svgY);

                    let deltaXClass = deltaX < 5 ? 'green' : deltaX < 10 ? 'yellow' : 'red';
                    let deltaYClass = deltaY < 5 ? 'green' : deltaY < 10 ? 'yellow' : 'red';

                    const row = tableBody.insertRow();
                    row.insertCell().textContent = poi.scene;
                    row.insertCell().textContent = poi.x.toFixed(2);
                    row.insertCell().textContent = poi.y.toFixed(2);
                    row.insertCell().textContent = poi.z.toFixed(2);
                    row.insertCell().textContent = poi.label;
                    row.insertCell().textContent = poi.svgX.toFixed(2);
                    row.insertCell().textContent = poi.svgY.toFixed(2);
                    row.insertCell().textContent = calcSvgX.toFixed(2);
                    row.insertCell().textContent = calcSvgY.toFixed(2);
                    const deltaXCell = row.insertCell();
                    deltaXCell.textContent = deltaX.toFixed(2);
                    deltaXCell.className = deltaXClass;
                    const deltaYCell = row.insertCell();
                    deltaYCell.textContent = deltaY.toFixed(2);
                    deltaYCell.className = deltaYClass;
                });
            } catch (error) {
                document.getElementById('loading').innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
                console.error(error);
            }
        }

        loadData();
    </script>
</body>
</html>