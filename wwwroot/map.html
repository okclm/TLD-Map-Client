<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TLD Dynamic Map</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        #map-svg {
            width: 100vw;
            height: 100vh;
        }

        .poi {
            cursor: pointer;
            fill: red;
            stroke: white;
            stroke-width: 1;
        }

        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="status">Loading map...</div>
    <svg id="map-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 600">
        <!-- Image and POIs added dynamically -->
    </svg>

    <script>
        const SERVER_URL = 'http://localhost:8080'; // Change to your mod's port
        const REGIONS_JSON_URL = 'https://raw.githubusercontent.com/YOURUSERNAME/YOURREPO/main/regions.json';
        const POIS_BASE_URL = 'https://raw.githubusercontent.com/YOURUSERNAME/YOURREPO/main/pois/';

        let currentScene = null;

        // Fetch current scene from mod server
        async function getCurrentScene() {
            try {
                const res = await fetch(`${SERVER_URL}/current-scene`);
                if (!res.ok) throw new Error('Server offline or error');
                const data = await res.json();
                return data.scene;
            } catch (err) {
                document.getElementById('status').textContent = 'Cannot connect to game. Is it running?';
                console.error(err);
                return null;
            }
        }

        // Load map image and POIs for a scene
        async function loadMap(scene) {
            if (!scene) return;

            document.getElementById('status').textContent = `Loading ${scene}...`;

            const svg = document.getElementById('map-svg');
            svg.innerHTML = ''; // Clear previous

            // Load regions.json to get map URL
            const regions = await fetch(REGIONS_JSON_URL).then(r => r.json());
            const mapUrl = regions[scene];
            if (!mapUrl) {
                document.getElementById('status').textContent = `No map found for ${scene}`;
                return;
            }

            // Add image
            const image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
            image.setAttribute('href', mapUrl);
            image.setAttribute('width', '800');
            image.setAttribute('height', '600');
            svg.appendChild(image);

            // Load POIs
            const poisUrl = `${POIS_BASE_URL}${scene}.json`;
            try {
                const pois = await fetch(poisUrl).then(r => r.json());
                pois.forEach(poi => {
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', poi.svgX || '100'); // Fallback if missing
                    circle.setAttribute('cy', poi.svgY || '100');
                    circle.setAttribute('r', '8');
                    circle.classList.add('poi');
                    circle.onclick = () => teleport(poi.scene, poi.x, poi.y, poi.z);
                    circle.title = poi.label || 'POI'; // Tooltip
                    svg.appendChild(circle);
                });
                document.getElementById('status').textContent = `Map: ${scene} (${pois.length} POIs)`;
            } catch (err) {
                document.getElementById('status').textContent = `POIs not found for ${scene}`;
            }
        }

        // Teleport request
        function teleport(scene, x, y, z) {
            fetch(`${SERVER_URL}/teleport?scene=${encodeURIComponent(scene)}&x=${x}&y=${y}&z=${z}`)
                .then(res => {
                    if (!res.ok) return res.text().then(text => { throw new Error(text); });
                    return res.text();
                })
                .then(text => alert('Success: ' + text))
                .catch(err => {
                    alert('Teleport failed: ' + err.message);
                    if (err.message.includes('Wrong region')) {
                        // Auto-refresh to current scene
                        loadCurrentMap();
                    }
                });
        }

        // Initial load
        async function loadCurrentMap() {
            currentScene = await getCurrentScene();
            if (currentScene) loadMap(currentScene);
        }

        loadCurrentMap();
    </script>
</body>
</html>